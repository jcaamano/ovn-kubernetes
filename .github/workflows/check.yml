name: ovn-check

on:
  merge_group:
  pull_request:
    branches: [ master ]
  schedule:
    - cron: '0 */12 * * *'

concurrency:
  group: ovn-check-${{ github.head_ref || github.run_id }}
  cancel-in-progress: true

env:
  GO_VERSION: "1.18.4"

  # This must be a directory
  CI_IMAGE_CACHE: tmp/image_cache/
  CI_IMAGE_PR_TAR: image-pr.tar
  CI_DIST_IMAGES_OUTPUT: dist/images/_output/

jobs:

  dco:
    name: DCO
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
    - name: Get PR commits
      id: 'get-pr-commits'
      uses: tim-actions/get-pr-commits@v1.1.0
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    - name: Run DCO check
      uses: tim-actions/dco@v1.1.0
      with:
        commits: ${{ steps.get-pr-commits.outputs.commits }}
  
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
    - name: Check out code
      uses: actions/checkout@v3

    - name: Set up Go
      uses: actions/setup-go@v3
      with:
        go-version: ${{ env.GO_VERSION }}
      id: go

    - name: Verify
      uses: golangci/golangci-lint-action@v3
      with:
        version: v1.52
        working-directory: go-controller
        args: --modules-download-mode=vendor --timeout=15m0s --verbose

  build:
    uses: ./.github/workflows/build.yml
    with:
      test: true
      upload: true
